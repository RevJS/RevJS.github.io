<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Creating an API - RevJS Guide</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../css/highlight.css" rel="stylesheet">
  <link href="../../css/style.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Creating an API";
    var mkdocs_page_input_path = "api/creating_an_api.md";
    var mkdocs_page_url = "/api/creating_an_api/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> RevJS Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Welcome to RevJS!</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Working with Models</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../models/creating_models/">Creating Models</a>
                </li>
                <li class="">
                    
    <a class="" href="../../models/creating_data/">Creating Model Data</a>
                </li>
                <li class="">
                    
    <a class="" href="../../models/reading_data/">Reading Model Data</a>
                </li>
                <li class="">
                    
    <a class="" href="../../models/updating_data/">Updating Model Data</a>
                </li>
                <li class="">
                    
    <a class="" href="../../models/deleting_data/">Deleting Model Data</a>
                </li>
                <li class="">
                    
    <a class="" href="../../models/related_data/">Working with Related Models</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Creating a GraphQL API</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Creating an API</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#creating-a-graphql-api">Creating a GraphQL API</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#registering-api-models">Registering API Models</a></li>
        
            <li><a class="toctree-l4" href="#exposing-your-api-via-http">Exposing your API via HTTP</a></li>
        
            <li><a class="toctree-l4" href="#graphql-query-schema">GraphQL Query Schema</a></li>
        
            <li><a class="toctree-l4" href="#graphql-mutation-schema">GraphQL Mutation Schema</a></li>
        
            <li><a class="toctree-l4" href="#security">Security</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">RevJS Module Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../components/rev-models/">rev-models</a>
                </li>
                <li class="">
                    
    <a class="" href="../../components/rev-backend-mongodb/">rev-backend-mongodb</a>
                </li>
                <li class="">
                    
    <a class="" href="../../components/rev-api/">rev-api</a>
                </li>
                <li class="">
                    
    <a class="" href="../../components/rev-api-client/">rev-api-client</a>
                </li>
                <li class="">
                    
    <a class="" href="../../components/rev-ui/">rev-ui</a>
                </li>
                <li class="">
                    
    <a class="" href="../../changelog/">Change Log</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">RevJS Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Creating a GraphQL API &raquo;</li>
        
      
    
    <li>Creating an API</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/RevJS/revjs/edit/master/docs/mkdocs/src/api/creating_an_api.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="creating-a-graphql-api">Creating a GraphQL API<a class="headerlink" href="#creating-a-graphql-api" title="Permanent link">&para;</a></h1>
<p>The <code>rev-api</code> module of RevJS allows you to easily make your models available
over the network, via an automatically-generated GraphQL API.</p>
<ul>
<li>Models are exposed via the <strong>ModelApiManager.register()</strong> method, and you can
  choose to expose all of your models via the API, or just a subset of them.</li>
<li>You can choose which <strong>operations</strong> (create, read, update, remove) to allow
  on your models via the API.</li>
<li>You can also expose some of your <strong>model methods</strong> as <strong>GraphQL mutations</strong>.</li>
</ul>
<h2 id="registering-api-models">Registering API Models<a class="headerlink" href="#registering-api-models" title="Permanent link">&para;</a></h2>
<p>The example below shows how to specify the allowed operations for specific
models, and register them with an API:</p>
<pre><code class="ts">
import {
    AutoNumberField, TextField, RelatedModel, RelatedModelList,
    ModelManager, InMemoryBackend
} from 'rev-models';
import { ApiOperations } from 'rev-api/lib/decorators';
import { ModelApiManager } from 'rev-api';

// Use the @ApiOperations decorator to specify what operations are allowed for each model

@ApiOperations(
    ['read']
)
export class User {
    @AutoNumberField({ primaryKey: true })
        id: number;
    @TextField()
        username: string;
    @RelatedModelList({ model: 'Post', field: 'user' })
        posts: Post[];
    @RelatedModelList({ model: 'Comment', field: 'user' })
        comments: Comment[];

    constructor(data?: Partial&lt;User&gt;) {
        Object.assign(this, data);
    }
}

@ApiOperations(
    ['create', 'read', 'update', 'remove']
)
export class Post {
    @AutoNumberField({ primaryKey: true })
        id: number;
    @RelatedModel({ model: 'User' })
        user: User;
    @TextField()
        title: string;
    @TextField({ multiLine: true })
        body: string;
    @RelatedModelList({ model: 'Comment', field: 'post' })
        comments: Comment[];

    constructor(data?: Partial&lt;Post&gt;) {
        Object.assign(this, data);
    }
}

@ApiOperations(
    ['create', 'read', 'remove']
)
export class Comment {
    @AutoNumberField({ primaryKey: true })
        id: number;
    @RelatedModel({ model: 'Post' })
        post: Post;
    @RelatedModel({ model: 'User', required: false })
        user: User;
    @TextField()
        comment: string;

    constructor(data?: Partial&lt;Comment&gt;) {
        Object.assign(this, data);
    }
}

export const modelManager = new ModelManager();
modelManager.registerBackend('default', new InMemoryBackend());
modelManager.register(User);
modelManager.register(Post);
modelManager.register(Comment);

export const api = new ModelApiManager(modelManager);
api.register(User);
api.register(Post);
api.register(Comment)
</code></pre>

<p><strong>NOTE:</strong> The seperate import from <code>rev-api/lib/decorators</code> is designed so you
can share the same model definition between your front and back-end code,
without inadvertently including <code>rev-api</code> back-end code in your front-end
bundle.</p>
<h2 id="exposing-your-api-via-http">Exposing your API via HTTP<a class="headerlink" href="#exposing-your-api-via-http" title="Permanent link">&para;</a></h2>
<p>APIs created via <code>rev-api</code> can be exposed by any web framework that can
serve <a href="https://github.com/graphql/graphql-js">GraphQL JS</a> schemas. A good
example is <a href="https://github.com/apollographql/apollo-server">Apollo GraphQL Server</a>
which supports most popular NodeJS Web Frameworks.</p>
<p>In the example below, we use apollo graphql server to serve our API:</p>
<pre><code class="ts">
import * as koa from 'koa';
import * as koaRouter from 'koa-router';
import * as koaBody from 'koa-bodyparser';
import { graphqlKoa, graphiqlKoa } from 'graphql-server-koa';

// Load RevJS API and generate GrapQL Schema

import { api } from './defining_an_api';
import { createData } from './model_data';

const schema = api.getGraphQLSchema();

// Create Koa &amp; Apollo GraphQL Server

const app = new koa();
const port = 3000;

const router = new koaRouter();
router.post('/graphql', graphqlKoa({ schema: schema }));
router.get('/graphql', graphqlKoa({ schema: schema }));
router.get('/graphiql', graphiqlKoa({ endpointURL: '/graphql' }));

app.use(koaBody());
app.use(router.routes());
app.use(router.allowedMethods());

app.listen(port);

console.log(`GraphQL Server is running on port ${port}.`);
console.log(`GraphiQL UI is running at http://localhost:${port}/graphiql`);

// Load sample data

createData()
.then(() =&gt; {
    console.log('Data Loaded.');
})
.catch((e) =&gt; {
    console.error('Error loading data', e);
})
</code></pre>

<h2 id="graphql-query-schema">GraphQL Query Schema<a class="headerlink" href="#graphql-query-schema" title="Permanent link">&para;</a></h2>
<p>The GraphQL <code>query {}</code> schema lets you read models and fields in a hierarchical
way.</p>
<ul>
<li>RevJS generates a top-level Query object for each model you expose for
  <strong>read</strong> access</li>
<li>You can use the standard <code>read()</code> function options (<code>where</code>, <code>limit</code>,
 <code>offset</code> and <code>orderBy</code>) when querying the top-level Query objects</li>
<li>Query objects contain a <code>results</code> key, containing the matching models, and
  a <code>meta</code> key, containing the current <code>limit</code>, <code>offset</code> and <code>totalCount</code> values.</li>
<li>RevJS respects the <strong>RelatedModel</strong> and <strong>RelatedModelList</strong> fields you define
  on your models, and you can drill-down on these fields to any level in your
  GraphQL query.</li>
</ul>
<p>The screenshot below shows the GraphQL Query Schema generated from the examples
above:</p>
<p><img alt="GraphQL Query Schema" src="../../img/graphql-query.png" /></p>
<h2 id="graphql-mutation-schema">GraphQL Mutation Schema<a class="headerlink" href="#graphql-mutation-schema" title="Permanent link">&para;</a></h2>
<p>The GraphQL <code>mutation {}</code> schema provides access to <code>create()</code>, <code>update()</code> and
<code>remove()</code> functions, for all models you have enabled these for. Any
custom API Methods you have created will also be available here.</p>
<p>The screenshot below shows the GraphQL Mutation Schema generated from the
examples above:</p>
<p><img alt="GraphQL Mutation Schema" src="../../img/graphql-mutations.png" /></p>
<h2 id="security">Security<a class="headerlink" href="#security" title="Permanent link">&para;</a></h2>
<p>It is <strong>very</strong> important to consider security when exposing data via an API.
Currently you must implement security policies in your models, and at the Web
Server layer (e.g. by securiing your API with
<a href="http://www.passportjs.org/">Passport</a>).</p>
<p>In future releases we may implement support for <em>middleware</em>, which could be used
for authentication and authorisation, but currently we do not have support for
this. Contributions welcome! :)</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../components/rev-models/" class="btn btn-neutral float-right" title="rev-models">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../models/related_data/" class="btn btn-neutral" title="Working with Related Models"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/RevJS/revjs/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../models/related_data/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../components/rev-models/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/highlight.pack.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>

</body>
</html>
